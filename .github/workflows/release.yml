on:
  push:
    branches:
      - master
      
jobs:
  semantic-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Semantic Release
        uses: cycjimmy/semantic-release-action@v4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  deploy-to-aws:
    runs-on: ubuntu-latest
    permissions:
        id-token: write
        contents: read
    steps:
        - name: Checkout code
          uses: actions/checkout@v2
        - name: Configure AWS credentials
          uses: aws-actions/configure-aws-credentials@v1
          with:
              aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
              aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
              aws-region: eu-west-1
        - name: Redeploy Challenge Strava
          env:
              SSH_KEY: ${{ secrets.SSH_KEY }}
          run: |
              echo "${SSH_KEY}" > key.pem
              chmod 400 key.pem
              ssh -o "StrictHostKeyChecking no" -i key.pem ubuntu@ec2-34-244-233-236.eu-west-1.compute.amazonaws.com "cd BetPlatform && sudo docker compose down && git pull -f && sudo docker compose up --build -d"
